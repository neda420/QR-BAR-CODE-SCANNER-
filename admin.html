<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Scanner - Admin</title>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background-color: #f0f2f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            flex-grow: 1;
        }
        .header {
            background-color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: left;
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="text-2xl font-bold">Admin Panel</h1>
        <button id="logoutBtn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Logout</button>
    </div>

    <div class="container">
        <!-- Analytics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="card text-center">
                <p class="text-gray-500 text-sm">Total Scans</p>
                <p class="text-3xl font-bold" id="totalScansCount">0</p>
            </div>
            <div class="card text-center">
                <p class="text-gray-500 text-sm">Total Users</p>
                <p class="text-3xl font-bold" id="totalUsersCount">0</p>
            </div>
            <div class="card text-center">
                <p class="text-gray-500 text-sm">Active Today</p>
                <p class="text-3xl font-bold" id="activeTodayCount">0</p>
            </div>
        </div>

        <!-- Master Controls -->
        <div class="card">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                <h2 class="text-xl font-semibold mb-2 md:mb-0">All Scan History</h2>
                <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 w-full md:w-auto">
                    <input type="text" id="globalSearch" placeholder="Global search..." class="p-2 border rounded w-full">
                    <select id="filterType" class="p-2 border rounded w-full">
                        <option value="all">All</option>
                        <option value="URL">URLs</option>
                        <option value="TEXT">Text</option>
                    </select>
                    <button id="exportAllCsvBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded w-full">Download All (CSV)</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>User Email</th>
                            <th>Type</th>
                            <th>Content</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminScanTableBody">
                        <!-- Scan history will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
         
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const scanHistoryRef = db.collection('scan_history');
        
        const ADMIN_EMAIL = "nadim015582@gmail.com"; 

        const logoutBtn = document.getElementById('logoutBtn');
        const totalScansCount = document.getElementById('totalScansCount');
        const totalUsersCount = document.getElementById('totalUsersCount');
        const activeTodayCount = document.getElementById('activeTodayCount');
        const globalSearchInput = document.getElementById('globalSearch');
        const filterTypeSelect = document.getElementById('filterType');
        const exportAllCsvBtn = document.getElementById('exportAllCsvBtn');
        const adminScanTableBody = document.getElementById('adminScanTableBody');

        let allScans = [];
        let allUsers = [];

        auth.onAuthStateChanged(user => {
            if (user) {
                if (user.email !== ADMIN_EMAIL) {
                    window.location.href = 'index.html'; // Redirect non-admins
                } else {
                    fetchAdminData();
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await auth.signOut();
            window.location.href = 'index.html';
        });

        async function fetchAdminData() {

            console.log("Attempting to fetch admin data..."); // Debug log

            // Added a second function (error handler) to onSnapshot
            scanHistoryRef.orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                console.log("Data received!", snapshot.size, "documents"); // Debug log

                allScans = [];
                let userEmails = new Set();
                let activeToday = new Set();
                const today = new Date().toLocaleDateString();
                snapshot.forEach(doc => {
                    const scan = { id: doc.id, ...doc.data() };
                    allScans.push(scan);
                    userEmails.add(scan.email);
                    if (new Date(scan.date_string).toLocaleDateString() === today) {
                        activeToday.add(scan.email);
                    }
                });
                totalScansCount.textContent = allScans.length;
                totalUsersCount.textContent = userEmails.size;
                activeTodayCount.textContent = activeToday.size;
                renderAdminScanTable(allScans);
            }, error => {
                console.error("Error fetching admin data:", error);
                alert("Dashboard Error: " + error.message + "\n\nCheck your Browser Console (F12) for details.");
            });
        }

        function renderAdminScanTable(scans) {
            adminScanTableBody.innerHTML = '';
            scans.forEach(scan => {
                const row = document.createElement('tr');
                const userEmailDisplay = scan.email === 'Anonymous' 
                    ? '<span class="text-gray-500">Anonymous</span>' 
                    : `<span class="font-medium">${scan.email}</span>`;
                
                row.innerHTML = `
                    <td>${scan.date_string}</td>
                    <td>${userEmailDisplay}</td>
                    <td>${scan.type}</td>
                    <td>${scan.content.length > 70 ? scan.content.substring(0, 70) + '...' : scan.content}</td>
                    <td>
                        <button onclick="deleteScanAdmin('${scan.id}')" class="bg-red-500 hover:bg-red-700 text-white text-sm py-1 px-3 rounded">Delete</button>
                    </td>
                `;
                adminScanTableBody.appendChild(row);
            });
        }

        async function deleteScanAdmin(scanId) {
            if (confirm('Are you sure you want to delete this scan permanently?')) {
                await scanHistoryRef.doc(scanId).delete();
            }
        }

        globalSearchInput.addEventListener('input', filterAndSearchScans);
        filterTypeSelect.addEventListener('change', filterAndSearchScans);

        function filterAndSearchScans() {
            const searchTerm = globalSearchInput.value.toLowerCase();
            const filterType = filterTypeSelect.value;

            let filtered = allScans.filter(scan => {
                const matchesSearch = (
                    scan.content.toLowerCase().includes(searchTerm) ||
                    scan.email.toLowerCase().includes(searchTerm) ||
                    scan.date_string.toLowerCase().includes(searchTerm)
                );

                const matchesType = (
                    filterType === 'all' || scan.type === filterType
                );
                return matchesSearch && matchesType;
            });
            renderAdminScanTable(filtered);
        }

        exportAllCsvBtn.addEventListener('click', () => {
            exportToCsv(allScans, 'all_scan_history.csv');
        });

        function exportToCsv(data, filename) {
            if (data.length === 0) {
                alert("No data to export.");
                return;
            }

            const header = ["Timestamp", "User Email", "Type", "Content"];
            const rows = data.map(item => [
                item.date_string,
                item.email,
                item.type,
                `"${item.content.replace(/"/g, '""')}"`
            ]);

            let csvContent = header.join(",") + "\n";
            rows.forEach(row => {
                csvContent += row.join(",") + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>
</body>
</html>
